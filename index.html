<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Afiliado Helper (feio e funcional)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 820px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    input { flex: 1; padding: 10px; font-size: 14px; }
    button { padding: 10px 12px; cursor: pointer; }
    .card { margin-top: 14px; border: 1px solid #ddd; border-radius: 10px; padding: 12px; display: none; gap: 12px; }
    .card.show { display: flex; }
    img { width: 120px; height: 120px; object-fit: contain; border: 1px solid #eee; border-radius: 8px; background: #fff; }
    .title { font-weight: 700; margin: 0 0 8px; }
    .muted { color: #666; font-size: 13px; margin: 6px 0; }
    .price { font-size: 18px; font-weight: 800; margin: 10px 0; }
    .actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    textarea { width: 100%; height: 110px; margin-top: 12px; padding: 10px; font-size: 14px; }
    .error { margin-top: 10px; color: #b00020; font-weight: 700; }
    .ok { margin-top: 10px; color: #0b6b0b; font-weight: 700; }
    .history { margin-top: 14px; }
    .history button { padding: 6px 10px; font-size: 12px; }
    .chip { display: inline-flex; gap: 6px; align-items: center; border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; margin: 6px 6px 0 0; background: #fafafa; }
    .chip small { color: #555; }
  </style>
</head>
<body>
  <h1>Afiliado Helper (feio e funcional)</h1>

  <div class="row">
    <input id="url" placeholder="Cole aqui o link do produto (ML/Amazon/Ali...)" />
    <button id="buscar">Buscar</button>
    <button id="limpar">Limpar</button>
  </div>

  <div id="status" class="muted"></div>
  <div id="msg" class="error" style="display:none;"></div>
  <div id="ok" class="ok" style="display:none;"></div>

  <div id="card" class="card">
    <img id="img" alt="Imagem do produto" />
    <div style="flex:1;">
      <div id="store" class="muted"></div>
      <div id="title" class="title"></div>
      <div id="price" class="price"></div>
      <div id="extra" class="muted"></div>

      <div class="actions">
        <button id="copiarTexto">Copiar texto</button>
        <button id="copiarLink">Copiar link</button>
        <button id="abrir">Abrir produto</button>
      </div>
    </div>
  </div>

  <textarea id="texto" placeholder="O texto pronto vai aparecer aqui..."></textarea>

  <div class="history">
    <div class="muted"><b>Hist√≥rico (√∫ltimos 10)</b></div>
    <div id="historyList"></div>
  </div>

<script>
  const BACKEND_URL = "https://afiliado-helper-backend.vercel.app/api/preview";

  const elUrl = document.getElementById("url");
  const elBuscar = document.getElementById("buscar");
  const elLimpar = document.getElementById("limpar");
  const elStatus = document.getElementById("status");
  const elMsg = document.getElementById("msg");
  const elOk = document.getElementById("ok");

  const elCard = document.getElementById("card");
  const elImg = document.getElementById("img");
  const elStore = document.getElementById("store");
  const elTitle = document.getElementById("title");
  const elPrice = document.getElementById("price");
  const elExtra = document.getElementById("extra");
  const elTexto = document.getElementById("texto");

  const elCopiarTexto = document.getElementById("copiarTexto");
  const elCopiarLink = document.getElementById("copiarLink");
  const elAbrir = document.getElementById("abrir");

  const elHistoryList = document.getElementById("historyList");
  const HISTORY_KEY = "afiliado_helper_history_v1";

  let lastUrl = "";
  let lastData = null;

  function showError(text) {
    elMsg.style.display = "block";
    elOk.style.display = "none";
    elMsg.textContent = text;
  }
  function showOk(text) {
    elOk.style.display = "block";
    elMsg.style.display = "none";
    elOk.textContent = text;
  }
  function clearMsgs() {
    elMsg.style.display = "none";
    elOk.style.display = "none";
    elMsg.textContent = "";
    elOk.textContent = "";
  }

  function formatBRL(v) {
    if (v === null || v === undefined || v === "") return "Pre√ßo: (n√£o achei)";
    const n = Number(v);
    if (!Number.isFinite(n)) return `Pre√ßo: ${v}`;
    return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function buildText(data, url) {
    const title = data?.title || "Produto";
    const price = formatBRL(data?.price);
    return `üìå ${title}\nüí∞ ${price}\nüîó ${url}`;
  }

  function loadHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    } catch {
      return [];
    }
  }
  function saveHistory(items) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(items.slice(0, 10)));
  }
  function addToHistory(url, title, store) {
    const items = loadHistory();
    const next = [{ url, title, store, at: Date.now() }, ...items.filter(i => i.url !== url)];
    saveHistory(next);
    renderHistory();
  }

  function renderHistory() {
    const items = loadHistory();
    elHistoryList.innerHTML = "";
    if (!items.length) {
      elHistoryList.innerHTML = `<div class="muted">Sem hist√≥rico ainda.</div>`;
      return;
    }
    for (const it of items) {
      const div = document.createElement("div");
      div.className = "chip";
      div.innerHTML = `<small>${it.store || "?"}</small> <span>${(it.title || "Sem t√≠tulo").slice(0, 40)}</span>`;
      div.style.cursor = "pointer";
      div.onclick = () => {
        elUrl.value = it.url;
        buscar();
      };
      elHistoryList.appendChild(div);
    }
  }

  async function buscar() {
    clearMsgs();
    const url = elUrl.value.trim();
    if (!url) return showError("Cole um link primeiro.");

    lastUrl = url;
    lastData = null;

    elStatus.textContent = "Buscando...";
    elCard.classList.remove("show");
    elTexto.value = "";

    try {
      const api = `${BACKEND_URL}?url=${encodeURIComponent(url)}`;
      const r = await fetch(api);
      const data = await r.json();

      if (!r.ok || data.error) {
        elStatus.textContent = "";
        return showError(data.message || data.error || "Deu ruim na busca.");
      }

      lastData = data;

      elStore.textContent = `Loja: ${data.store || "-"}`;
      elTitle.textContent = data.title || "(sem t√≠tulo)";
      elPrice.textContent = formatBRL(data.price);

      elImg.src = data.image || "";
      elImg.style.display = data.image ? "block" : "none";

      elExtra.textContent = data.source ? `Fonte: ${data.source}` : "";

      elTexto.value = buildText(data, url);
      elCard.classList.add("show");
      elStatus.textContent = "";

      addToHistory(url, data.title || "", data.store || "");
      showOk("Pronto. S√≥ copiar e mandar no grupo üòÑ");
    } catch (e) {
      elStatus.textContent = "";
      showError("Falhou ao chamar o backend. Verifica se o link do backend t√° certo.");
    }
  }

  async function copy(text) {
    try {
      await navigator.clipboard.writeText(text);
      showOk("Copiado ‚úÖ");
    } catch {
      showError("N√£o consegui copiar. Tenta copiar manualmente.");
    }
  }

  elBuscar.onclick = buscar;
  elLimpar.onclick = () => {
    elUrl.value = "";
    elTexto.value = "";
    elCard.classList.remove("show");
    clearMsgs();
    elStatus.textContent = "";
  };

  elCopiarTexto.onclick = () => {
    if (!lastData) return showError("Busca um produto primeiro.");
    copy(elTexto.value);
  };

  elCopiarLink.onclick = () => {
    if (!lastUrl) return showError("Cola um link primeiro.");
    copy(lastUrl);
  };

  elAbrir.onclick = () => {
    if (!lastUrl) return showError("Cola um link primeiro.");
    window.open(lastUrl, "_blank");
  };

  // Enter pra buscar
  elUrl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") buscar();
  });

  renderHistory();
</script>
</body>
</html>
